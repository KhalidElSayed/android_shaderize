
precision mediump float;

uniform float uSteps;
uniform sampler2D sTexturePass1;
uniform sampler2D sTexturePass2;
uniform vec2 uDelta0;
uniform vec2 uDelta1;
varying vec2 vTextureCoord;

void main() {
	float sum = 1.0;
	vec2 textureCoord1 = vTextureCoord - uDelta0 * 0.5;
	gl_FragColor = texture2D(sTexturePass1, vTextureCoord);
	float coc = gl_FragColor.a;
	for (float t = 0.0; coc * uSteps >= t; ++t) {
		textureCoord1 += uDelta1;
		vec4 sample = texture2D(sTexturePass1, textureCoord1);
		if (sample.a * uSteps >= t) {
			gl_FragColor += sample;
			sum += 1.0;
		}
	}
	gl_FragColor /= sum;
	gl_FragColor += texture2D(sTexturePass2, vTextureCoord - uDelta1 * 0.5);
	gl_FragColor *= 0.5;
}
